name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK & Tools
      run: |
        yes | sdkmanager "ndk;27.2.12479018" "platforms;android-36" "build-tools;34.0.0" "cmake;3.22.1"
        echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/27.2.12479018" >> $GITHUB_ENV

    # --- THE REFINED FIX ---
    - name: Patch Build Scripts (Precision Mode)
      run: |
        echo "Patching scripts..."
        
        # Define the flags we need for the CONFIGURATION step
        FLAGS="-DOPENSSL_USE_STATIC_LIBS=TRUE -DWITH_BROTLI=OFF -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=BOTH -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=BOTH -DCMAKE_FIND_ROOT_PATH_MODE_PACKAGE=BOTH"
        
        # Use sed to replace 'cmake ' with 'cmake $FLAGS ' 
        # BUT ignore lines containing '--build' or '--install' to avoid breaking the build/install steps.
        # Syntax: /pattern/!s/find/replace/g -> If line does NOT match pattern, do the replace.
        
        find . -name "build_picoquic.sh" -exec sed -i "/--build/!s/cmake /cmake $FLAGS /g" {} +
        
        # Double check: ensure we didn't patch the --install line if it exists separately
        find . -name "build_picoquic.sh" -exec sed -i "/--install/!s/cmake /cmake /g" {} +
        # (The second command is a safety no-op, the first one is the key)

        echo "Verification - The Config line should have flags, the Build line should NOT:"
        grep "cmake" app/src/main/rust/slipstream-rust/scripts/build_picoquic.sh || true

    - name: Setup Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: slipstream-apks
        path: plugin/build/outputs/apk/debug/*.apk
